<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Answer Keyy Checker</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; background: #f0f0f0; }
input, button { padding: 6px 12px; margin: 5px; }
#scoreBoard { display:none; margin-top: 15px; background:#fff; padding:15px; border-radius:8px; box-shadow:0 0 8px rgba(0,0,0,0.1);}
.section { font-weight:bold; margin-bottom:5px; }
</style>
</head>
<body>

<h2>Answer Keyy Checker</h2>
<input type="text" id="urlInput" placeholder="Paste test URL here" size="50">
<button onclick="loadTest()">Load Test</button>
<button onclick="checkScore()">Check Score</button>
<button id="downloadBtn" onclick="downloadScore()" style="display:none;">Download HTML</button>

<div id="scoreBoard"></div>

<script>
let testDOM = null; // Will hold loaded test DOM

// ===== Load test HTML =====
async function loadTest(){
    const url = document.getElementById("urlInput").value.trim();
    if(!url) return alert("Enter a test URL!");
    try{
        const response = await fetch(url);
        if(!response.ok) throw new Error("Unable to fetch test page");
        const htmlText = await response.text();
        const parser = new DOMParser();
        testDOM = parser.parseFromString(htmlText, "text/html");
        alert("Test loaded successfully! Now click 'Check Score'.");
    }catch(e){
        alert("Error loading test: "+e.message);
    }
}

// ===== Dynamically detect sections and compute scores =====
function checkScore(){
    if(!testDOM) return alert("Please load a test first!");
    const questions = Array.from(testDOM.getElementsByClassName("question-pnl"));
    if(!questions.length) return alert("No questions found in the test page!");

    // Detect section headers dynamically
    const sectionElements = Array.from(testDOM.querySelectorAll(".question-section, .section-title, h2, h3"));
    let sections = [];
    if(sectionElements.length){
        for(let i=0;i<sectionElements.length;i++){
            const secName = sectionElements[i].textContent.trim() || `Section ${i+1}`;
            // Find nearest question index after the section
            let startIndex = questions.findIndex(q => sectionElements[i].compareDocumentPosition(q) & Node.DOCUMENT_POSITION_FOLLOWING ? true : false);
            if(startIndex===-1) startIndex = questions.length-1;
            sections.push({name:secName, start:startIndex});
        }
    } else {
        sections.push({name:"Section 1", start:0});
    }

    // Set end index for each section
    for(let i=0;i<sections.length;i++){
        sections[i].end = (i<sections.length-1)? sections[i+1].start : questions.length;
    }

    let scoreHTML = "", totalScore=0;

    sections.forEach(sec=>{
        let secScore=0;
        for(let i=sec.start;i<sec.end;i++){
            const userAnsElem = questions[i].querySelector(".bold:nth-child(6)"); // adjust if needed
            const userAns = userAnsElem?.textContent.trim();
            const correctAns = questions[i].getAttribute("data-correct") || userAns; // embed correct answer in HTML
            if(userAns && userAns === correctAns) secScore++;
        }
        totalScore += secScore;
        scoreHTML += `<div class="section">${sec.name}: ${secScore} / ${sec.end - sec.start}</div>`;
    });

    scoreHTML += `<div class="section" style="font-size:1.2em; margin-top:10px;">Total: ${totalScore} / ${questions.length}</div>`;

    const board = document.getElementById("scoreBoard");
    board.innerHTML = scoreHTML;
    board.style.display="block";
    document.getElementById("downloadBtn").style.display="inline-block";
}

// ===== Download score as HTML =====
function downloadScore(){
    const content = document.getElementById("scoreBoard").innerHTML;
    const blob = new Blob([`<html><body>${content}</body></html>`], {type:"text/html"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "score.html";
    a.click();
    URL.revokeObjectURL(url);
}
</script>

</body>
</html>
