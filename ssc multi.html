<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SSC Auto-Detect Score Checker</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
h1 { text-align: center; color: #333; }
input, button { padding: 8px; margin: 5px; }
table { border-collapse: collapse; margin: 20px auto; width: 95%; max-width: 800px; background: #fff; display:block; overflow-x:auto; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
th { background: #2c7be5; color: #fff; }
tr:nth-child(even) { background: #f9f9f9; }
#result { margin-top: 20px; }
</style>
</head>
<body>
<h1>SSC Auto-Detect Score Checker</h1>

<div style="text-align:center;">
  <p><strong>Option 1: Load from URL (requires CORS)</strong></p>
  <input type="text" id="urlInput" size="80" placeholder="Paste SSC answer key URL here">
  <button onclick="loadURL()">Load URL</button>
  <button onclick="downloadHTML()" id="downloadBtn" disabled>Download HTML</button>
  <br><br>
  <p><strong>Option 2: Upload HTML file</strong></p>
  <input type="file" id="fileInput" accept=".html">
  <button onclick="loadFile()">Load File</button>
  <br><br>
  <button onclick="checkScore()" id="checkBtn" disabled>Check Score</button>
</div>

<div id="result"></div>

<script>
let loadedDoc = null;
let loadedHTMLText = "";

// --- Load via URL ---
async function loadURL() {
  const url = document.getElementById("urlInput").value.trim();
  if (!url) { alert("Please enter a valid URL."); return; }

  try {
    const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
    const data = await response.json();
    loadedHTMLText = data.contents;

    const parser = new DOMParser();
    loadedDoc = parser.parseFromString(loadedHTMLText, "text/html");

    alert("Page loaded successfully! You can now check the score or download the HTML.");
    document.getElementById("checkBtn").disabled = false;
    document.getElementById("downloadBtn").disabled = false;
  } catch (err) {
    alert("Error loading page. Likely due to CORS restrictions: " + err);
  }
}

// --- Download loaded HTML ---
function downloadHTML() {
  if (!loadedHTMLText) { alert("No HTML loaded yet."); return; }
  const blob = new Blob([loadedHTMLText], {type: "text/html"});
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "ssc_page.html";
  link.click();
}

// --- Load via File ---
function loadFile() {
  const fileInput = document.getElementById('fileInput');
  if (!fileInput.files.length) { alert('Please select an HTML file.'); return; }

  const file = fileInput.files[0];
  const reader = new FileReader();

  reader.onload = function(e) {
    loadedHTMLText = e.target.result;
    const parser = new DOMParser();
    loadedDoc = parser.parseFromString(loadedHTMLText, "text/html");

    alert("File loaded successfully! You can now check the score.");
    document.getElementById("checkBtn").disabled = false;
  };

  reader.readAsText(file);
}

// --- Auto-detect and Check Score ---
function checkScore() {
  if (!loadedDoc) { alert("No HTML loaded yet."); return; }

  const body = loadedDoc.body;

  // --- Detect sections ---
  let sectionElements = Array.from(body.querySelectorAll('div, span')).filter(el => {
    return /module|section|part/i.test(el.innerText);
  });

  // If none, single default section
  if (!sectionElements.length) sectionElements = [{innerText:"General"}];

  let grandTotal = 0;
  let output = `<table>
    <tr>
      <th>Section</th>
      <th>Total Qs</th>
      <th>Attempted</th>
      <th>Right</th>
      <th>Wrong</th>
      <th>Not Attempted</th>
      <th>Bonus</th>
      <th>Marks</th>
    </tr>`;

  // Loop over each section
  sectionElements.forEach(secEl => {
    const secName = secEl.innerText.trim();
    let sectionStats = { total:0, right:0, wrong:0, notAttempted:0, bonus:0, marks:0 };

    // All following question panels until next section
    let questions = [];
    let sibling = secEl.nextElementSibling;
    while(sibling && !/module|section|part/i.test(sibling.innerText)){
      if (sibling.classList.contains("question-pnl")) questions.push(sibling);
      sibling = sibling.nextElementSibling;
    }

    questions.forEach(q => {
      sectionStats.total++;

      // Chosen option detection
      let chosenOption = "--";
      try {
        const tds = q.querySelectorAll("td.bold");
        tds.forEach((td,i)=>{
          if(tds[i-1]?.textContent.trim().toLowerCase().includes("chosen")) chosenOption = td.textContent.trim();
        });
      } catch(e){}

      if(chosenOption === "--") sectionStats.notAttempted++;

      // Correct answer detection (look for rightAns class or tick icon)
      let correctOption = null;
      try {
        const correctTd = q.querySelector(".rightAns");
        if(correctTd) correctOption = correctTd.textContent.trim().split(".")[0];
        else {
          // fallback: first td with tick icon img
          const imgTick = q.querySelector("img[src*='tick']");
          if(imgTick) correctOption = imgTick.parentElement.textContent.trim().split(".")[0];
        }
      } catch(e){}

      if(correctOption==null){
        sectionStats.bonus++;
        sectionStats.marks += 2;
      } else if(chosenOption === "--") {
        // no marks
      } else if(chosenOption === correctOption) {
        sectionStats.right++;
        sectionStats.marks += 2;
      } else {
        sectionStats.wrong++;
        sectionStats.marks -= 0.5;
      }
    });

    grandTotal += sectionStats.marks;

    output += `<tr>
      <td>${secName}</td>
      <td>${sectionStats.total}</td>
      <td>${sectionStats.total - sectionStats.notAttempted}</td>
      <td>${sectionStats.right}</td>
      <td>${sectionStats.wrong}</td>
      <td>${sectionStats.notAttempted}</td>
      <td>${sectionStats.bonus}</td>
      <td style="color:${sectionStats.marks<0?'red':'black'}">${sectionStats.marks.toFixed(2)}</td>
    </tr>`;
  });

  output += `<tr style="font-weight:bold; background:#e7f5fe;">
      <td colspan="7">Grand Total</td>
      <td>${grandTotal.toFixed(2)}</td>
    </tr></table>`;

  document.getElementById("result").innerHTML = output;
}
</script>
</body>
</html>
